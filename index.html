<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Heater Monitoring</title>
  <script src="js/chartJS.js"></script>
  <script src="js/moment.js"></script>
  <script src="js/adapter-moment-chartJS.js"></script>
  <script src="js/hammer.js"></script>
  <script src="js/chartJS-zoom.js"></script>
  <script src="js/easepick.js"></script>
  <link rel="shortcut icon"
    href="data:image/x-icon;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABHNCSVQICAgIfAhkiAAABMpJREFUWIXtl3mIVWUYxn/ve5Z7RueOzcw1x1HzuhQ1LpkmqBWOjWmZZZJDEC0qLSQaYVImtNBGC2NlG4L5nxASRRRBC/2hBVpktos5WjNjTGY2jc5yl3Pe/phzm1FnTIgb/tEDB77v+Z7zPc/3nu07cDIUeNz3/clxf53rujPj9mhVfbmPdqnjONfH7VLgpbKysoq4P09V747bs1T1gX68TobruvOAb4CE53kXAz8BSQBV3ayqjwGkUqmkiHQAo+Oxe0XkzcI8ItLouu7cuP254zg39OenJxKe5+0RkSrf98fncrn9qppwXXcSgOM4O4EFAIcPH+4Qkb2e580F8H3/C2BWKpUqhP2soFXVncBVpxWgpKSkDfgziqJUOp3uNLNDZjYMwMwazWx4LI3M7EAYhsPjsRYg0dXVNSju74uiqDDWWGj/IxKJxLnAsjjMSOAuQOIKLAJmAKTT6QC4HwgAXNedBSzsM9UqYHh83u3A2P78nBMroqrXiEhkZl/n8/n2ZDJ5LJvNrgBmJxKJxnw+vx2gra2tSlUnqGqFme2Joqi5urq6paOj4z4zm+N53h9RFG2LK3DUdd36KIpagSMDrl5V75xSMsQmBWXmOM7ymF45pWSILSgbZsCWmBviqrbeVpG2miBpqrom5i84y/FsRWqMAa0A9fX1jog031w+ykTk50I1B8Izj1fV2CNV5xvwEbAaePOOyrRtHjXVgC+A1aq6sbY0ZTZlsX047hITkcZY+9Q4f7A11cw3oD3m1rqIRRdeZwpGfMkKcAdKMm1ied30iVr31fe/w8Ee7rwxpVPrZpRO3XegFf2u5/4NxGFohT92yZVnN/za2szu7T3aksBJLq8/p+FY2wG2vDPwik96Cgq44tJhrF87gmtn9wk1qZzn1o3hloXHa0ePGMQLD57P6pt7ueRglw0PTebRFQObnzLAf4X/A5wZAXzfX+w4zkfATcU2FJFtqvpi4aupQRDMSQ4K3li97Oq6WReOO7339b/AE2tunX7Z1PErjx49uhVAs9nskiULa/XSaTVUDBlcbH+mTZnA7dfPxvecy8vKyio0iqJgUEmi6Ma9EFzHwXddaW9vD1zA3n7/Uz7Z+SVNLYeY4Y8sqv3DDZvJdXfQlckCmJtIJJ7e3/TLqP1NtACVVLGomAF27Pr+RmBT/Ilu1Uwm8yOwH9gN7C2meYy3gFwYhh8Adma8B/4P0B9y+YiOrohsvpcL80Znd0gmd7w2jIyOrpDuTC9nBp1dIV3dpw4w4IakYdPesGETEaB3VPbsHbe+1xJtfa8lBHR+snc/uevbtuisiz4OARnn98z525GMJSe/mwfEPYXPcRVQ1bA9ytEe5lHVJwEfuMd6Ja8Dvud5M/dmjnE4n2FH5xFE5N1YO7mP9hDgp9PppAnRL/luDEIg6i/Iq/RsoyeIyEERaQYuAHAcZylgAqaqG/8uneuuV5FuEfnB9/2JAEEQjAbyAiYi+/osbIOIZFX1+ZhqA1KFiZ4FckDW87xlcVVOvDeC+DiOr62t7a+0fqx1+9OqahMQicifQDnAa+urJ9mdlWkD1lB8dDbXXGmVjm9ANar6Sqk6Foiaqq4qtruItFU6vikSAkMLv1jV8XHin1IxUB57DQX4C43VkIwDmXPyAAAAAElFTkSuQmCC" />
  <style>
    header {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
      margin-inline: 1rem;
      padding: .5rem;
    }

    h1 {
      font-family: Verdana, Geneva, Tahoma, sans-serif;
      margin: 0;
    }

    input {
      cursor: pointer;
      border: none;
      font-size: 1.2rem;
      position: relative;
    }



    button {
      border: 1px solid black;
      border-radius: 3px;
      cursor: pointer;
    }

    #dateSumbmit {
      opacity: 0;
    }

    #datepicker {
      width: 300px;
    }

    #chart-area-container {
      margin-inline: 1rem;
      padding: .5rem;
      padding-left: 2rem;
      border: 1px solid black;
      border-radius: .5rem;
    }
  </style>
</head>
</head>

<body>
  <header>
    <h1>Heater Monitoring</h1>


    <input id="datepicker" />
    <form id="setDate">
      <input type="date" id="startDate" />
      -
      <input type="date" id="endDate" />
      <button id="dateSumbmit">Submit</button>
    </form>
    <div></div>

  </header>
  <div id="chart-area-container">
    <canvas id="myChart"></canvas>
    <button onclick="resetChartZoom()">reset Zoom</button>
  </div>

  <script>
    // ELEMENTS
    var myChart = ''
    const el = document.getElementById('chart-area');
    const setDate = document.getElementById('setDate');
    const endDateElement = document.querySelector('#endDate');
    const startDateElement = document.querySelector('#startDate');
    const dateSumbmit = document.querySelector('#dateSumbmit');
    const myChartElement = document.querySelector('#myChart');
    const datepickerElement = document.querySelector('#datepicker');
    var startDate
    var endDate
    const DateTime = easepick.DateTime;

    // SETTINGS
    let hash = location.hash.split('_');
    if (hash[0].replace('#', '').length === 10 && hash[1].length === 10) {
      startDate = hash[0].replace('#', '')
      endDate = hash[1]
    } else {
      startDate = new DateTime().format('YYYY-MM-DD');
      endDate = new DateTime().format('YYYY-MM-DD');
    }


    setDate.addEventListener('submit', fetchNewDataFF);
    endDateElement.addEventListener('change', showSubmit);
    startDateElement.addEventListener('change', showSubmit);
    startDateElement.value = startDate
    endDateElement.value = endDate
    datepickerElement.value = `${startDate} - ${endDate}`;



    // PICKER
    // const tomorrow = today.clone().add(1, 'day');

    const picker = new easepick.create({
      element: datepickerElement,
      css: ["css/easepick.css"],
      zIndex: 1000,
      lang: "de-DE",
      format: "DD MMM YYYY",
      plugins: [
        "AmpPlugin",
        "RangePlugin"
      ],
      setup(picker) {
        picker.on('select', (e) => {
          const {start, end} = e.detail;
          startDate = start.format('YYYY-MM-DD');
          endDate = end.format('YYYY-MM-DD');
          location.hash = startDate + '_' + endDate;
          fetchNewDataEasePick()
        });
      },
    })

    // CHART CONFIG
    var config = {
      type: 'line',
      options: {
        responsive: true,
        scales: {
          x: {
            type: 'time',
            distribution: 'series',
            ticks: {
              maxTicksLimit: 12,
              maxRotation: 0,
              callback: timeFormat,
              // source: 'label',
            },
            time: {
              parser: 'YYYY-MM-DD HH:mm:ss',
              unit: 'hour',
              // stepSize: 3600,

              tooltipFormat: 'DD.MM.YYYY HH:mm',
              displayFormats: {
                // second: 'HH:mm',
                // minute: 'HH:mm',
                hour: 'DD.MM.YYYY HH:mm'
              }
            },
            // scaleLabel: {
            //   display: true,
            //   labelString: 'Time'
            // },
          },
          Yleft: {
            type: 'linear',
            display: true,
            position: 'left',
            min: 0,
            max: 70,
          },
          Yright: {
            type: 'linear',
            display: true,
            position: 'right',
            min: 0,
            max: 100,
            grid: {
              drawOnChartArea: false,
            },
          },
        },
        elements: {
          point: {
            radius: 0,
          },
        },
        interaction: {
          intersect: false,
          axis: 'x',
          mode: 'nearest',
        },
        transitions: {
          zoom: {
            animation: {
              duration: 1000,
              easing: 'easeOutCubic'
            }
          }
        },
        plugins: {
          tooltip: {
            usePointStyle: true,
            enabled: true,
            position: 'average',
            bodyColor: 'white',
            callbacks: {
              label: function (context) {
                let unit = context.dataset.unit || '';
                let label = context.dataset.label || '';
                let value = context.parsed.y || '';
                // console.log(context)
                return label + ' ' + value + ' ' + unit;
              }
            }
          },
          zoom: {
            zoom: {
              wheel: {
                enabled: true,
                speed: 0.1,
              },
              drag: {
                enabled: true,
                borderColor: 'rgb(54, 162, 235)',
                borderWidth: 1,
                backgroundColor: 'rgba(54, 162, 235, 0.3)'
              },
              pinch: {
                enabled: true
              },
              mode: 'x',
            }
          }
        },
      }
    };


    function timeFormat(time) {
      // console.log(time)
      if (time.slice(-5) == '00:00') {
        return time.slice(0, 10)
      } else {
        return time.slice(-5)
      }
    }
    function resetChartZoom() {
      myChart.resetZoom()
    };





    function showSubmit() {
      dateSumbmit.style.opacity = 1;
    }




    async function fetchFirstData() {
      const response = await fetch(`/fetch.php?startDate=${startDate}&endDate=${endDate}`);
      const data = await response.json();
      return data;
    }


    async function fetchNewDataEasePick() {
      location.hash = startDate + '_' + endDate;

      const response = await fetch(`/fetch.php?startDate=${startDate}&endDate=${endDate}`);
      const data = await response.json();
      console.log(data)
      myChart.config.data = data
      myChart.update();
    }


    async function fetchNewDataFF(event) {
      dateSumbmit.style.opacity = 0;
      event.preventDefault();
      location.hash = startDateElement.value + '_' + endDateElement.value;
      const response = await fetch(`/fetch.php?startDate=${startDateElement.value}&endDate=${endDateElement.value}`);
      const data = await response.json();
      console.log(data)
      myChart.config.data = data
      myChart.update();
    }



    // CHART
    fetchFirstData()
      .then(data => {
        console.log(data)
        config.data = data
        myChart = new Chart(myChartElement, config);
      });
  </script>
</body>

</html>