<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Heizungsmessung</title>
  <script src="js/chartJS.js"></script>
  <script src="js/moment.js"></script>
  <script src="js/adapter-moment-chartJS.js"></script>
  <script src="js/hammer.js"></script>
  <script src="js/chartJS-zoom.js"></script>
  <script src="js/easepick.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-crosshair@1.2.0/dist/chartjs-plugin-crosshair.min.js"></script>
  <script src="js/chartJS-annotation.js"></script>
  <link rel="shortcut icon"
    href="data:image/x-icon;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABHNCSVQICAgIfAhkiAAABMpJREFUWIXtl3mIVWUYxn/ve5Z7RueOzcw1x1HzuhQ1LpkmqBWOjWmZZZJDEC0qLSQaYVImtNBGC2NlG4L5nxASRRRBC/2hBVpktos5WjNjTGY2jc5yl3Pe/phzm1FnTIgb/tEDB77v+Z7zPc/3nu07cDIUeNz3/clxf53rujPj9mhVfbmPdqnjONfH7VLgpbKysoq4P09V747bs1T1gX68TobruvOAb4CE53kXAz8BSQBV3ayqjwGkUqmkiHQAo+Oxe0XkzcI8ItLouu7cuP254zg39OenJxKe5+0RkSrf98fncrn9qppwXXcSgOM4O4EFAIcPH+4Qkb2e580F8H3/C2BWKpUqhP2soFXVncBVpxWgpKSkDfgziqJUOp3uNLNDZjYMwMwazWx4LI3M7EAYhsPjsRYg0dXVNSju74uiqDDWWGj/IxKJxLnAsjjMSOAuQOIKLAJmAKTT6QC4HwgAXNedBSzsM9UqYHh83u3A2P78nBMroqrXiEhkZl/n8/n2ZDJ5LJvNrgBmJxKJxnw+vx2gra2tSlUnqGqFme2Joqi5urq6paOj4z4zm+N53h9RFG2LK3DUdd36KIpagSMDrl5V75xSMsQmBWXmOM7ymF45pWSILSgbZsCWmBviqrbeVpG2miBpqrom5i84y/FsRWqMAa0A9fX1jog031w+ykTk50I1B8Izj1fV2CNV5xvwEbAaePOOyrRtHjXVgC+A1aq6sbY0ZTZlsX047hITkcZY+9Q4f7A11cw3oD3m1rqIRRdeZwpGfMkKcAdKMm1ied30iVr31fe/w8Ee7rwxpVPrZpRO3XegFf2u5/4NxGFohT92yZVnN/za2szu7T3aksBJLq8/p+FY2wG2vDPwik96Cgq44tJhrF87gmtn9wk1qZzn1o3hloXHa0ePGMQLD57P6pt7ueRglw0PTebRFQObnzLAf4X/A5wZAXzfX+w4zkfATcU2FJFtqvpi4aupQRDMSQ4K3li97Oq6WReOO7339b/AE2tunX7Z1PErjx49uhVAs9nskiULa/XSaTVUDBlcbH+mTZnA7dfPxvecy8vKyio0iqJgUEmi6Ma9EFzHwXddaW9vD1zA3n7/Uz7Z+SVNLYeY4Y8sqv3DDZvJdXfQlckCmJtIJJ7e3/TLqP1NtACVVLGomAF27Pr+RmBT/Ilu1Uwm8yOwH9gN7C2meYy3gFwYhh8Adma8B/4P0B9y+YiOrohsvpcL80Znd0gmd7w2jIyOrpDuTC9nBp1dIV3dpw4w4IakYdPesGETEaB3VPbsHbe+1xJtfa8lBHR+snc/uevbtuisiz4OARnn98z525GMJSe/mwfEPYXPcRVQ1bA9ytEe5lHVJwEfuMd6Ja8Dvud5M/dmjnE4n2FH5xFE5N1YO7mP9hDgp9PppAnRL/luDEIg6i/Iq/RsoyeIyEERaQYuAHAcZylgAqaqG/8uneuuV5FuEfnB9/2JAEEQjAbyAiYi+/osbIOIZFX1+ZhqA1KFiZ4FckDW87xlcVVOvDeC+DiOr62t7a+0fqx1+9OqahMQicifQDnAa+urJ9mdlWkD1lB8dDbXXGmVjm9ANar6Sqk6Foiaqq4qtruItFU6vikSAkMLv1jV8XHin1IxUB57DQX4C43VkIwDmXPyAAAAAElFTkSuQmCC" />
  <style>
    * {
      transition: all .5s;
    }

    header {
      display: flex;
      flex-direction: row;
      align-items: baseline;
      justify-content: space-between;
      margin-inline: 2rem;
      padding: .5rem;
    }

    h1 {
      font-family: Verdana, Geneva, Tahoma, sans-serif;
      margin: 0;
    }

    input {
      cursor: pointer;
      border: 1px solid transparent;
      font-size: 1.2rem;
      position: relative;
      background: none;
      padding: .5rem;
    }

    #selectESP {
      cursor: pointer;
      border: 1px solid transparent;
      padding: .5rem;
      font-size: 1.2rem;
      position: relative;
      background: none;
    }

    input:focus,
    input:hover,
    #selectESP:hover {
      border: 1px solid cornflowerblue;
      border-radius: .5rem;
    }

    button {
      border: 1px solid black;
      border-radius: 3px;
      cursor: pointer;
    }

    #dateSumbmit {
      opacity: 0;
      color: cornflowerblue;
      border: 1px solid cornflowerblue;
      border-radius: .5rem;
      padding: .5rem;

    }

    #datepicker {
      width: 300px;
      display: none;
    }

    #setDate {
      display: none;
    }

    #chart-area-container {
      margin-inline: 1rem;
      padding: .5rem;
      padding-left: 2rem;
      border: 1px solid black;
      border-radius: .5rem;
    }

    .chartButtons {
      display: flex;
      align-items: center;
      justify-content: end;
      gap: 1rem;
      margin-top: 1rem;
      margin-right: 2rem;
    }

    a {
      text-decoration: none;
      color: cornflowerblue;
    }

    a:hover {
      color: rgb(76, 111, 177);
    }

    .chartButtons button {
      border: none;
      background: none;
      color: cornflowerblue;
    }

    .chartButtons button:hover {
      color: rgb(76, 111, 177);
    }

    .dbLinks {
      display: flex;
      align-items: center;
      justify-content: start;
      gap: 1rem;
      margin-top: 1rem;
      margin-left: 2rem;
    }

    .switchMode {
      position: relative;
    }

    .tooltip:hover::after {
      content: attr(data-tooltip);
      background: #333;
      background: rgba(0, 0, 0, .8);
      border-radius: 5px;
      bottom: 26px;
      color: #fff;
      right: 20%;
      padding: 5px;
      position: absolute;
      z-index: 98;
      width: 200px;
    }
  </style>
</head>
</head>

<body>
  <header>
    <a href="./">
      <h1>Heizungsmessung</h1>
    </a>

    <select onchange="changeESP()" name="selectESP" id="selectESP"></select>

    <input id="datepicker" />

    <form id="setDate">
      <input type="date" id="startDate" />
      -
      <input type="date" id="endDate" />
      <button id="dateSumbmit">Submit</button>
    </form>
    <a href="https://github.com/KoljaL/heater-monitoring/" target="_blank">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
        <path
          d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" />
      </svg>
    </a>

  </header>
  <div id="chart-area-container">
    <canvas id="lineChart"></canvas>
    <div class="chartButtons">
      <button onclick="resetChartZoom()">reset Zoom</button>
      <button class="switchMode tooltip" onclick="steppedChart(this)" data-tooltip="switch between stepped, tension and default mode">default</button>
    </div>
  </div>
  <div class="dbLinks">
    <a target="_blank" href="./store/assets/dummy.php">reset Database</a>
  </div>

  <script>
    // ELEMENTS 
    const selectESP = document.querySelector('#selectESP');
    const lineChartElement = document.querySelector('#lineChart');

    // for firefox
    const setDate = document.getElementById('setDate');
    const endDateElement = document.querySelector('#endDate');
    const startDateElement = document.querySelector('#startDate');
    const dateSumbmit = document.querySelector('#dateSumbmit');
    // for all others
    const datepickerElement = document.querySelector('#datepicker');


    // SETTINGS
    var startDate, endDate, lineChart, ESP, config, tickRunner;
    // var ESP = 'haus_one'
    const DateTime = easepick.DateTime;
    // get dates from url
    let hash = location.hash.replace('#', '').split(':');
    if (hash[0].length === 10 && hash[1].length === 10) {
      startDate = hash[0]
      endDate = hash[1]
    }
    // or set today as date
    else {
      startDate = new DateTime().format('YYYY-MM-DD');
      endDate = new DateTime().format('YYYY-MM-DD');
      location.hash = startDate + ':' + endDate;
    }


    /**
     * 
     * BROWSER SWITCH
     * because FF has problems with the dateRangePicker
     * 
     */

    // for Firefox
    //
    if (navigator.userAgent.includes('Firefox')) {

      setDate.style.display = 'block';
      startDateElement.value = startDate
      endDateElement.value = endDate
      setDate.addEventListener('submit', fetchNewDataFF);
      endDateElement.addEventListener('change', () => {
        dateSumbmit.style.opacity = 1;
      });
      startDateElement.addEventListener('change', () => {
        dateSumbmit.style.opacity = 1;
      });
    }// onlyFF

    // for everyone else
    //
    else {
      datepickerElement.style.display = 'block'
      let pickerStart = new DateTime(startDate).format('DD MMM YYYY')
      let pickerEnd = new DateTime(endDate).format('DD MMM YYYY')
      datepickerElement.value = pickerStart + ' - ' + pickerEnd;

      // EASEPICK
      //
      // const tomorrow = today.clone().add(1, 'day');
      const picker = new easepick.create({
        element: datepickerElement,
        css: ["css/easepick.css"],
        zIndex: 1000,
        lang: "de-DE",
        format: "DD MMM YYYY",
        plugins: [
          "AmpPlugin",
          "RangePlugin"
        ],
        setup(picker) {
          picker.on('select', (e) => {
            const {start, end} = e.detail;
            startDate = start.format('YYYY-MM-DD');
            endDate = end.format('YYYY-MM-DD');
            location.hash = startDate + ':' + endDate;
            fetchNewDataEasePick()
          });
        },
      })
    } // noFF


    /**
     * 
     * CHART CONFIG config.options.plugins.zoom.limits
     * 
     */
    config = {
      type: 'line',
      options: {
        spanGaps: true,
        responsive: true,
        animation: {
          y: {
            type: 'number',
            easing: 'easeOutQuad',
            duration: 100,
            from: NaN,
            delay(ctx) {
              if (ctx.type !== 'data' || ctx.yStarted) {
                return 0;
              }
              ctx.yStarted = true;
              return ctx.index * 1;
            }
          }
        },
        scales: {
          x: {
            type: 'time',
            distribution: 'series',
            min: startDate || null,
            max: endDate || null,

            ticks: {
              // min: startDate || null,
              // max: endDate || null, 
              // autoSkip: true,
              // autoSkipPadding: 50,
              // maxTicksLimit: 12,
              maxRotation: 0,
              callback: timeFormat,
            },
            time: {
              parser: 'YYYY-MM-DD HH:mm:ss',
              unit: 'hour',
              tooltipFormat: 'DD.MM.YYYY HH:mm',
              displayFormats: {
                hour: 'DD.MM.YYYY HH:mm'
              }
            },
          },
          Yleft: {
            type: 'linear',
            display: true,
            position: 'left',
            min: -10,
            max: 100,
          },
          Yright: {
            type: 'linear',
            display: true,
            position: 'right',
            min: -10,
            max: 100,
            grid: {
              drawOnChartArea: false,
            },
          },
        },
        elements: {
          line: {
            tension: 0,
            stepped: false,
          },
          point: {
            radius: 0,
          },
        },
        interaction: {
          intersect: false,
          axis: 'x',
          mode: 'nearest',
        },
        transitions: {
          zoom: {
            animation: {
              duration: 1000,
              easing: 'easeOutCubic'
            }
          }
        },
        plugins: {
          tooltip: {
            // mode: 'interpolate',
            // intersect: true,
            animation: true,
            usePointStyle: true,
            enabled: true,
            position: 'average',
            bodyColor: 'white',
            callbacks: {
              label: function (context) {
                let unit = context.dataset.unit || '';
                let label = context.dataset.label || '';
                let value = context.parsed.y || '';
                // console.log(context)
                return label + ' ' + value + ' ' + unit;
              }
            }
          },
          zoom: {
            limits: {
              x: {},
              y: {}
            },
            zoom: {
              mode: 'x',
              wheel: {
                enabled: true,
                speed: 0.1,
              },
              drag: {
                enabled: true,
                borderColor: 'rgb(54, 162, 235)',
                borderWidth: 1,
                backgroundColor: 'rgba(54, 162, 235, 0.3)'
              },
              pinch: {
                enabled: true
              },
            }
          },
          annotation: {
            drawTime: 'beforeDraw',
            annotations: {},
          },
          crosshair: {
            line: {
              color: '#F66',  // crosshair line color
              width: 1        // crosshair line width
            },
            // sync: {
            //   enabled: true,            // enable trace line syncing with other charts
            //   group: 1,                 // chart group
            //   suppressTooltips: false   // suppress tooltips when showing a synced tracer
            // },
            // zoom: {
            //   enabled: true,                                      // enable zooming
            //   zoomboxBackgroundColor: 'rgba(66,133,244,0.2)',     // background color of zoom box 
            //   zoomboxBorderColor: '#48F',                         // border color of zoom box
            //   zoomButtonText: 'Reset Zoom',                       // reset zoom button text
            //   zoomButtonClass: 'reset-zoom',                      // reset zoom button class
            // },
            // callbacks: {
            //   beforeZoom: () => function (start, end) {                  // called before zoom, return false to prevent zoom
            //     return true;
            //   },
            //   afterZoom: () => function (start, end) {                   // called after zoom
            //   }
            // }
          },
        },
      }
    };


    function makeDaychangeLines() {
      var i = 0;
      var line = 'line_'
      var stepRunner;
      // const timeSteps = lineChart.data.labels;
      lineChart.data.labels.forEach(step => {
        if (step.slice(8, 10) !== stepRunner) {
          stepRunner = step.slice(8, 10)

          let date = step.slice(0, 10) + ' 00:00:00'

          i++
          console.log(date)
          lineChart.options.plugins.annotation.annotations[line + i] = {
            type: 'line',
            xMin: new Date(date).valueOf(),
            xMax: new Date(date).valueOf(),
            borderColor: 'rgba(0, 0, 0, 0.2)',
            // label: {
            //   position: 'start',
            //   color: 'rgba(0, 0, 0, 0.5)',
            //   backgroundColor: 'rgba(0,0,0,0)',
            //   enabled: true,
            //   content: step
            // }
          }
        }
      });


      console.log(config.options.plugins.annotation.annotations)
      lineChart.update();

    }
    /**
     * 
     * tick format for x axis
     * set 00:00 to full date
     * 
     */
    function timeFormat(time) {
      // console.log(time)
      // console.log(tickRunner)


      if (tickRunner !== time.slice(0, 2)) {
        tickRunner = time.slice(0, 2);
        // console.log(tickRunner)
        // console.log(time.slice(0, 10))
        return time.slice(0, 10)
      } else {

        return time.slice(-5)
      }

      // if (time.slice(-5) == '00:00') {
      //   return time.slice(0, 10)
      // } else {
      //   return time.slice(-5)
      // }
    }


    /**
     * 
     * reset zoom
     * 
     */
    function resetChartZoom() {
      lineChart.resetZoom()
      makeDaychangeLines()
    };


    /**
     * 
     * after fetch, set new limits for zoom -> dont zoom out
     * 
     */
    function setZoomLimits() {
      // console.log(startDate)
      // console.log(endDate)
      let zoomMin = new DateTime(startDate).valueOf()//.format('YYYY-MM-DD HH:mm:ss')
      let zoomMax = new DateTime(endDate).valueOf() + 1000 * 60 * 60 * 24 - 1000//.format('YYYY-MM-DD HH:mm:ss')
      // console.log(zoomMin)
      // console.log(new DateTime(zoomMax).format('YYYY-MM-DD HH:mm:ss'))
      lineChart.options.plugins.zoom.limits.x.min = zoomMin;
      lineChart.options.plugins.zoom.limits.x.max = zoomMax
      // console.log(config.options.plugins.zoom.limits.x)
    }



    /**
     * 
     * change the behaviour of the line
     * 
     */
    function steppedChart(el) {
      if (el.innerHTML === 'stepped') {
        el.innerHTML = 'tension'
        lineChart.options.elements.line.stepped = false;
        lineChart.options.elements.line.tension = .5;
      }

      else if (el.innerHTML === 'tension') {
        el.innerHTML = 'default'
        lineChart.options.elements.line.stepped = false;
        lineChart.options.elements.line.tension = 0;
      }
      else if (el.innerHTML === 'default') {
        el.innerHTML = 'stepped'
        lineChart.options.elements.line.stepped = true;
        lineChart.options.elements.line.tension = 0;
      }
      lineChart.update();
    }



    /**
     * 
     * fetch new data from date picker
     * 
     */
    async function fetchNewDataEasePick() {
      location.hash = startDate + ':' + endDate;
      const response = await fetch(`./store/assets/fetch.php?ESP=${ESP}&startDate=${startDate}&endDate=${endDate}`);
      const data = await response.json();
      console.log(data)
      lineChart.config.options.scales.x.min = startDate + " 00:00:00"
      lineChart.config.options.scales.x.max = endDate + " 23:59:59"
      lineChart.config.data = data
      lineChart.update();
      lineChart.resetZoom()
      // console.log(lineChart.config.options.scales.x)
      setZoomLimits()
      makeDaychangeLines()
    }


    /**
     * 
     * select a new ESP from dropdown
     * 
     */
    function changeESP() {
      ESP = selectESP.value
      fetchNewDataEasePick()
    }

    /**
     * 
     * for Firefox only
     * fetch new data from form elements
     * 
     */
    async function fetchNewDataFF(event) {
      dateSumbmit.style.opacity = 0;
      event.preventDefault();
      startDate = startDateElement.value
      endDate = endDateElement.value
      fetchNewDataEasePick()
    }



    /**
     * 
     * fetch first data and create new Chart
     * 
     */
    async function getConfig() {
      const response = await fetch(`./store/assets/fetch.php?config`);
      const data = await response.json();
      return data
    }




    /**
     * 
     * fetch first data and create new Chart
     * 
     */
    async function initChart() {
      const configPHP = await getConfig();
      console.info('configPHP', configPHP)

      ESP = Object.keys(configPHP)[0]
      ESPdropdown(Object.keys(configPHP));

      const responseD = await fetch(`./store/assets/fetch.php?ESP=${ESP}&startDate=${startDate}&endDate=${endDate}`);
      const data = await responseD.json();
      console.info('data', data)
      config.options.scales.x.min = startDate + " 00:00:00"
      config.options.scales.x.max = endDate + " 23:59:59"
      config.data = data
      lineChart = new Chart(lineChartElement, config);
      setZoomLimits()
      makeDaychangeLines()
    }

    /**
     * 
     * make options for ESP dropdown list
     * 
     */
    function ESPdropdown(keys) {
      let options;
      keys.forEach(key => {
        options += `<option value="${key}">${key.replace('_', ' ')}</option>`
      });
      selectESP.innerHTML = options;
    }

    /**
     * 
     * start function
     * fetch data &
     * fetch config &
     * initialize new chart
     * 
     */
    initChart() 
  </script>
</body>

</html>